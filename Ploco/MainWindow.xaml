<Window x:Class="Ploco.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:Ploco.Converters"
        xmlns:helpers="clr-namespace:Ploco.Helpers"
        Title="Ploco - Nouvelle version" Height="800" Width="1200"
        Icon="pack://application:,,,/img/train_logo.ico"
        Background="{DynamicResource AppBackgroundBrush}"
        Loaded="Window_Loaded" Closing="Window_Closing">
    <Window.Resources>
        <local:StatutToBrushConverter x:Key="StatutToBrushConverter"/>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        <SolidColorBrush x:Key="AppBackgroundBrush" Color="#FFF2F2F2"/>
        <SolidColorBrush x:Key="PanelBackgroundBrush" Color="#FFEFF4FF"/>
        <SolidColorBrush x:Key="CanvasBackgroundBrush" Color="#FFF7F7F7"/>
        <SolidColorBrush x:Key="TileBackgroundBrush" Color="White"/>
        <SolidColorBrush x:Key="TileBorderBrush" Color="#FFB0B0B0"/>
        <SolidColorBrush x:Key="TrackBorderBrush" Color="#FFE0E0E0"/>
        <SolidColorBrush x:Key="ListBackgroundBrush" Color="#FFF5F5F5"/>
        <SolidColorBrush x:Key="ListBorderBrush" Color="#FFDDDDDD"/>
        <SolidColorBrush x:Key="AppForegroundBrush" Color="#FF111111"/>
        <SolidColorBrush x:Key="MenuBackgroundBrush" Color="#FFF2F2F2"/>
        <SolidColorBrush x:Key="MenuBorderBrush" Color="#FFDDDDDD"/>
        <SolidColorBrush x:Key="ToolBarBackgroundBrush" Color="#FFF2F2F2"/>
        <SolidColorBrush x:Key="ToolBarBorderBrush" Color="#FFDDDDDD"/>
        <Style x:Key="DropListBoxStyle" TargetType="ListBox">
            <Setter Property="MinHeight" Value="48"/>
            <Setter Property="Background" Value="{DynamicResource ListBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ListBorderBrush}"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Padding" Value="4"/>
            <Setter Property="ScrollViewer.VerticalScrollBarVisibility" Value="Auto"/>
            <Setter Property="ScrollViewer.HorizontalScrollBarVisibility" Value="Disabled"/>
        </Style>
        <Style TargetType="ListBox">
            <Setter Property="Background" Value="{DynamicResource ListBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ListBorderBrush}"/>
        </Style>
        <Style TargetType="TextBlock">
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
        </Style>
        <Style TargetType="Menu">
            <Setter Property="Background" Value="{DynamicResource MenuBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource MenuBorderBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
        </Style>
        <Style TargetType="MenuItem">
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
            <Setter Property="Background" Value="{DynamicResource MenuBackgroundBrush}"/>
        </Style>
        <Style TargetType="ContextMenu">
            <Setter Property="Background" Value="{DynamicResource MenuBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource MenuBorderBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
        </Style>
        <Style TargetType="ToolBar">
            <Setter Property="Background" Value="{DynamicResource ToolBarBackgroundBrush}"/>
            <Setter Property="BorderBrush" Value="{DynamicResource ToolBarBorderBrush}"/>
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
        </Style>
        <Style TargetType="Button">
            <Setter Property="Foreground" Value="{DynamicResource AppForegroundBrush}"/>
        </Style>
        <Style x:Key="BlockedSwitchButtonBase" TargetType="Button">
            <Setter Property="MinWidth" Value="44"/>
            <Setter Property="Height" Value="20"/>
            <Setter Property="Margin" Value="4,0,0,0"/>
            <Setter Property="Padding" Value="6,0"/>
            <Setter Property="FontSize" Value="10"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
            <Setter Property="Background" Value="#FF2E7D32"/>
            <Setter Property="Foreground" Value="White"/>
            <Setter Property="BorderBrush" Value="#FF1B5E20"/>
            <Setter Property="BorderThickness" Value="1"/>
            <Setter Property="Content" Value="Libre"/>
        </Style>
        <Style x:Key="LeftBlockedSwitchStyle" TargetType="Button" BasedOn="{StaticResource BlockedSwitchButtonBase}">
            <Setter Property="ToolTip" Value="BLOCK"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsLeftBlocked}" Value="True">
                    <Setter Property="Background" Value="#FFD32F2F"/>
                    <Setter Property="BorderBrush" Value="#FFB71C1C"/>
                    <Setter Property="Content" Value="Plein"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding LeftLabel}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding LeftLabel}" Value="">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style x:Key="RightBlockedSwitchStyle" TargetType="Button" BasedOn="{StaticResource BlockedSwitchButtonBase}">
            <Setter Property="ToolTip" Value="BIF"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsRightBlocked}" Value="True">
                    <Setter Property="Background" Value="#FFD32F2F"/>
                    <Setter Property="BorderBrush" Value="#FFB71C1C"/>
                    <Setter Property="Content" Value="Plein"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding RightLabel}" Value="{x:Null}">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
                <DataTrigger Binding="{Binding RightLabel}" Value="">
                    <Setter Property="Visibility" Value="Collapsed"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <ContextMenu x:Key="LocomotiveTileContextMenu">
            <MenuItem Header="Modifier statut" Click="MenuItem_ModifierStatut_Click"/>
            <MenuItem Header="Loc HS" Click="MenuItem_LocHs_Click" InputGestureText="Ctrl+H"/>
            <MenuItem Header="Swap" Click="MenuItem_SwapPool_Click"/>
            <MenuItem Header="Retirer de la tuile" Click="MenuItem_RemoveFromTile_Click"/>
        </ContextMenu>
        <ContextMenu x:Key="LocomotiveListContextMenu">
            <MenuItem Header="Modifier statut" Click="MenuItem_ModifierStatut_Click"/>
            <MenuItem Header="Loc HS" Click="MenuItem_LocHs_Click" InputGestureText="Ctrl+H"/>
            <MenuItem Header="Swap" Click="MenuItem_SwapPool_Click"/>
        </ContextMenu>
        <DataTemplate x:Key="DepotTileTemplate">
            <Border Background="{DynamicResource TileBackgroundBrush}" BorderBrush="{DynamicResource TileBorderBrush}" BorderThickness="1"
                    CornerRadius="6" Padding="8" Width="{Binding Width}" Height="{Binding Height}" MinWidth="260" MinHeight="180"
                    AllowDrop="True"
                    Drop="Tile_Drop"
                    MouseLeftButtonDown="Tile_MouseLeftButtonDown"
                    MouseMove="Tile_MouseMove"
                    MouseLeftButtonUp="Tile_MouseLeftButtonUp">
                <Grid>
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding DisplayTitle}" FontWeight="Bold" FontSize="14"/>
                            <Menu Grid.Column="1" HorizontalAlignment="Right">
                                <MenuItem Header="...">
                                    <MenuItem Header="Renommer tuile" Click="RenameTile_Click" Tag="{Binding}"/>
                                    <MenuItem Header="Supprimer tuile" Click="DeleteTile_Click" Tag="{Binding}"/>
                                    <Separator/>
                                    <MenuItem Header="Ajouter voie de sortie" Click="AddDepotOutput_Click" Tag="{Binding}"/>
                                </MenuItem>
                            </Menu>
                        </Grid>
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <TextBlock Text="Locomotives" FontSize="12" Foreground="Gray" Margin="0,4,0,2"/>
                                <Grid>
                                    <ListBox x:Name="DepotMainList"
                                             DataContext="{Binding MainTrack}"
                                             ItemsSource="{Binding Locomotives}"
                                             Style="{StaticResource DropListBoxStyle}"
                                             AllowDrop="True"
                                             PreviewMouseLeftButtonDown="TrackLocomotives_PreviewMouseLeftButtonDown"
                                             PreviewMouseMove="TrackLocomotives_PreviewMouseMove"
                                             Drop="TrackLocomotives_Drop">
                                        <ListBox.ItemsPanel>
                                            <ItemsPanelTemplate>
                                                <WrapPanel Orientation="Horizontal"/>
                                            </ItemsPanelTemplate>
                                        </ListBox.ItemsPanel>
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                                        Padding="4" Margin="2" CornerRadius="4"
                                                        ContextMenu="{StaticResource LocomotiveTileContextMenu}">
                                                    <Grid>
                                                        <Grid.RowDefinitions>
                                                            <RowDefinition Height="Auto"/>
                                                            <RowDefinition Height="Auto"/>
                                                        </Grid.RowDefinitions>
                                                        <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                                   HorizontalAlignment="Left"/>
                                                        <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                                   HorizontalAlignment="Right" Margin="0,2,0,0">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Grid>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                    <TextBlock Text="Déposez ici" Foreground="SlateGray" FontStyle="Italic"
                                               HorizontalAlignment="Center" VerticalAlignment="Center">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding ElementName=DepotMainList, Path=HasItems}" Value="False">
                                                        <Setter Property="Visibility" Value="Visible"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                                <ItemsControl ItemsSource="{Binding OutputTracks}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{DynamicResource TrackBorderBrush}" BorderThickness="1" CornerRadius="4" Padding="6" Margin="0,6,0,6">
                                                <StackPanel>
                                                    <DockPanel>
                                                        <TextBlock Text="{Binding Name}" FontWeight="SemiBold" DockPanel.Dock="Left"/>
                                                        <TextBlock Text="Sortie" Foreground="SlateGray" DockPanel.Dock="Right" Margin="8,0,0,0"/>
                                                    </DockPanel>
                                                    <Grid>
                                                        <ListBox x:Name="DepotOutputList"
                                                                 ItemsSource="{Binding Locomotives}"
                                                                 Style="{StaticResource DropListBoxStyle}"
                                                                 AllowDrop="True"
                                                                 PreviewMouseLeftButtonDown="TrackLocomotives_PreviewMouseLeftButtonDown"
                                                                 PreviewMouseMove="TrackLocomotives_PreviewMouseMove"
                                                                 Drop="TrackLocomotives_Drop">
                                                            <ListBox.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <Canvas />
                                                                </ItemsPanelTemplate>
                                                            </ListBox.ItemsPanel>
                                                            <ListBox.ItemContainerStyle>
                                                                <Style TargetType="ListBoxItem">
                                                                    <Setter Property="Canvas.Left" Value="{Binding AssignedTrackOffsetX, TargetNullValue=0}"/>
                                                                    <Setter Property="Canvas.Top" Value="0"/>
                                                                </Style>
                                                            </ListBox.ItemContainerStyle>
                                                            <ListBox.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                                                            Padding="4" Margin="2" CornerRadius="4"
                                                                            ContextMenu="{StaticResource LocomotiveTileContextMenu}">
                                                                        <Grid>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>
                                                                            <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                                                       HorizontalAlignment="Left"/>
                                                                            <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                                                       HorizontalAlignment="Right" Margin="0,2,0,0">
                                                                                <TextBlock.Style>
                                                                                    <Style TargetType="TextBlock">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                        <Style.Triggers>
                                                                                            <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </TextBlock.Style>
                                                                            </TextBlock>
                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ListBox.ItemTemplate>
                                                        </ListBox>
                                                        <TextBlock Text="Déposez ici" Foreground="SlateGray" FontStyle="Italic"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding ElementName=DepotOutputList, Path=HasItems}" Value="False">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </ScrollViewer>
                    </StackPanel>
                    <Thumb Width="14" Height="14" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                           Cursor="SizeNWSE" DragDelta="TileResizeThumb_DragDelta" DragCompleted="TileResizeThumb_DragCompleted"
                           Background="#55000000" BorderBrush="#FF7A7A7A" BorderThickness="1"/>
                </Grid>
            </Border>
        </DataTemplate>
        <DataTemplate x:Key="GarageTileTemplate">
            <Border Background="{DynamicResource TileBackgroundBrush}" BorderBrush="{DynamicResource TileBorderBrush}" BorderThickness="1"
                    CornerRadius="6" Padding="8" Width="{Binding Width}" Height="{Binding Height}" MinWidth="260" MinHeight="180"
                    AllowDrop="True"
                    Drop="Tile_Drop"
                    MouseLeftButtonDown="Tile_MouseLeftButtonDown"
                    MouseMove="Tile_MouseMove"
                    MouseLeftButtonUp="Tile_MouseLeftButtonUp">
                <Grid>
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding DisplayTitle}" FontWeight="Bold" FontSize="14"/>
                            <Menu Grid.Column="1" HorizontalAlignment="Right">
                                <MenuItem Header="...">
                                    <MenuItem Header="Renommer tuile" Click="RenameTile_Click" Tag="{Binding}"/>
                                    <MenuItem Header="Supprimer tuile" Click="DeleteTile_Click" Tag="{Binding}"/>
                                    <Separator/>
                                    <MenuItem Header="Ajouter zone" Click="AddGarageZone_Click" Tag="{Binding}"/>
                                </MenuItem>
                            </Menu>
                        </Grid>
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <StackPanel>
                                    <StackPanel.Style>
                                        <Style TargetType="StackPanel">
                                            <Setter Property="Visibility" Value="Visible"/>
                                            <Style.Triggers>
                                                <DataTrigger Binding="{Binding MainTrack}" Value="{x:Null}">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </StackPanel.Style>
                                    <TextBlock Text="Zone principale" FontSize="12" Foreground="Gray" Margin="0,4,0,2"/>
                                    <Grid>
                                        <ListBox x:Name="GarageMainList"
                                                 DataContext="{Binding MainTrack}"
                                                 ItemsSource="{Binding Locomotives}"
                                                 Style="{StaticResource DropListBoxStyle}"
                                                 AllowDrop="True"
                                                 PreviewMouseLeftButtonDown="TrackLocomotives_PreviewMouseLeftButtonDown"
                                                 PreviewMouseMove="TrackLocomotives_PreviewMouseMove"
                                                 Drop="TrackLocomotives_Drop">
                                            <ListBox.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ListBox.ItemsPanel>
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                                            Padding="4" Margin="2" CornerRadius="4"
                                                            ContextMenu="{StaticResource LocomotiveTileContextMenu}">
                                                        <Grid>
                                                            <Grid.RowDefinitions>
                                                                <RowDefinition Height="Auto"/>
                                                                <RowDefinition Height="Auto"/>
                                                            </Grid.RowDefinitions>
                                                            <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                                       HorizontalAlignment="Left"/>
                                                            <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                                       HorizontalAlignment="Right" Margin="0,2,0,0">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                        </Grid>
                                                    </Border>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                        <TextBlock Text="Déposez ici" Foreground="SlateGray" FontStyle="Italic"
                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding ElementName=GarageMainList, Path=HasItems}" Value="False">
                                                            <Setter Property="Visibility" Value="Visible"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </StackPanel>
                                <ItemsControl ItemsSource="{Binding ZoneTracks}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Border BorderBrush="{DynamicResource TrackBorderBrush}" BorderThickness="1" CornerRadius="4" Padding="6" Margin="0,6,0,6">
                                                <StackPanel>
                                                    <Grid>
                                                        <Grid.ColumnDefinitions>
                                                            <ColumnDefinition Width="Auto"/>
                                                            <ColumnDefinition Width="*"/>
                                                            <ColumnDefinition Width="Auto"/>
                                                        </Grid.ColumnDefinitions>
                                                        <StackPanel Grid.Column="0" Orientation="Horizontal" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding LeftLabel}" FontWeight="SemiBold" Foreground="SlateGray">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding LeftLabel}" Value="{x:Null}">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding LeftLabel}" Value="">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <Button Style="{StaticResource LeftBlockedSwitchStyle}"
                                                                    Click="ToggleLeftBlocked_Click"/>
                                                        </StackPanel>
                                                        <Grid Grid.Column="1">
                                                            <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Margin="6,0,0,0" VerticalAlignment="Center">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Name}" Value="917">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <StackPanel Orientation="Horizontal" HorizontalAlignment="Center" VerticalAlignment="Center">
                                                                <StackPanel.Style>
                                                                    <Style TargetType="StackPanel">
                                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Name}" Value="917">
                                                                                <Setter Property="Visibility" Value="Visible"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </StackPanel.Style>
                                                                <TextBlock Text="{Binding Name}" FontWeight="SemiBold" Margin="0,0,6,0"/>
                                                                <Menu VerticalAlignment="Center">
                                                                    <MenuItem Header="...">
                                                                        <MenuItem Header="Renommer zone" Click="RenameZone_Click" Tag="{Binding}"/>
                                                                        <MenuItem Header="Supprimer zone" Click="RemoveZone_Click" Tag="{Binding}"/>
                                                                    </MenuItem>
                                                                </Menu>
                                                            </StackPanel>
                                                        </Grid>
                                                        <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center">
                                                            <Button Style="{StaticResource RightBlockedSwitchStyle}"
                                                                    Click="ToggleRightBlocked_Click"/>
                                                            <TextBlock Text="{Binding RightLabel}" FontWeight="SemiBold" Foreground="SlateGray">
                                                                <TextBlock.Style>
                                                                    <Style TargetType="TextBlock">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding RightLabel}" Value="{x:Null}">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                            <DataTrigger Binding="{Binding RightLabel}" Value="">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </TextBlock.Style>
                                                            </TextBlock>
                                                            <Menu HorizontalAlignment="Right" VerticalAlignment="Center">
                                                                <Menu.Style>
                                                                    <Style TargetType="Menu">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                        <Style.Triggers>
                                                                            <DataTrigger Binding="{Binding Name}" Value="917">
                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                            </DataTrigger>
                                                                        </Style.Triggers>
                                                                    </Style>
                                                                </Menu.Style>
                                                                <MenuItem Header="...">
                                                                    <MenuItem Header="Renommer zone" Click="RenameZone_Click" Tag="{Binding}"/>
                                                                    <MenuItem Header="Supprimer zone" Click="RemoveZone_Click" Tag="{Binding}"/>
                                                                </MenuItem>
                                                            </Menu>
                                                        </StackPanel>
                                                    </Grid>
                                                    <Grid>
                                                        <ListBox x:Name="GarageZoneList"
                                                                 ItemsSource="{Binding Locomotives}"
                                                                 Style="{StaticResource DropListBoxStyle}"
                                                                 AllowDrop="True"
                                                                 PreviewMouseLeftButtonDown="TrackLocomotives_PreviewMouseLeftButtonDown"
                                                                 PreviewMouseMove="TrackLocomotives_PreviewMouseMove"
                                                                 Drop="TrackLocomotives_Drop">
                                                            <ListBox.ItemsPanel>
                                                                <ItemsPanelTemplate>
                                                                    <Canvas />
                                                                </ItemsPanelTemplate>
                                                            </ListBox.ItemsPanel>
                                                            <ListBox.ItemContainerStyle>
                                                                <Style TargetType="ListBoxItem">
                                                                    <Setter Property="Canvas.Left" Value="{Binding AssignedTrackOffsetX, TargetNullValue=0}"/>
                                                                    <Setter Property="Canvas.Top" Value="0"/>
                                                                </Style>
                                                            </ListBox.ItemContainerStyle>
                                                            <ListBox.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                                                            Padding="4" Margin="2" CornerRadius="4"
                                                                            ContextMenu="{StaticResource LocomotiveTileContextMenu}">
                                                                        <Grid>
                                                                            <Grid.RowDefinitions>
                                                                                <RowDefinition Height="Auto"/>
                                                                                <RowDefinition Height="Auto"/>
                                                                            </Grid.RowDefinitions>
                                                                            <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                                                       HorizontalAlignment="Left"/>
                                                                            <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                                                       HorizontalAlignment="Right" Margin="0,2,0,0">
                                                                                <TextBlock.Style>
                                                                                    <Style TargetType="TextBlock">
                                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                                        <Style.Triggers>
                                                                                            <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                                            </DataTrigger>
                                                                                        </Style.Triggers>
                                                                                    </Style>
                                                                                </TextBlock.Style>
                                                                            </TextBlock>
                                                                        </Grid>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ListBox.ItemTemplate>
                                                        </ListBox>
                                                        <TextBlock Text="Déposez ici" Foreground="SlateGray" FontStyle="Italic"
                                                                   HorizontalAlignment="Center" VerticalAlignment="Center">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Visibility" Value="Collapsed"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding ElementName=GarageZoneList, Path=HasItems}" Value="False">
                                                                            <Setter Property="Visibility" Value="Visible"/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                    </Grid>
                                                </StackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </ScrollViewer>
                    </StackPanel>
                    <Thumb Width="14" Height="14" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                           Cursor="SizeNWSE" DragDelta="TileResizeThumb_DragDelta" DragCompleted="TileResizeThumb_DragCompleted"
                           Background="#55000000" BorderBrush="#FF7A7A7A" BorderThickness="1"/>
                </Grid>
            </Border>
        </DataTemplate>
        <DataTemplate x:Key="LineTileTemplate">
            <Border Background="{DynamicResource TileBackgroundBrush}" BorderBrush="{DynamicResource TileBorderBrush}" BorderThickness="1"
                    CornerRadius="6" Padding="8" Width="{Binding Width}" Height="{Binding Height}" MinWidth="260" MinHeight="180"
                    AllowDrop="True"
                    Drop="Tile_Drop"
                    MouseLeftButtonDown="Tile_MouseLeftButtonDown"
                    MouseMove="Tile_MouseMove"
                    MouseLeftButtonUp="Tile_MouseLeftButtonUp">
                <Grid>
                    <StackPanel>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="{Binding DisplayTitle}" FontWeight="Bold" FontSize="14"/>
                            <Menu Grid.Column="1" HorizontalAlignment="Right">
                                <MenuItem Header="...">
                                    <MenuItem Header="Renommer tuile" Click="RenameTile_Click" Tag="{Binding}"/>
                                    <MenuItem Header="Supprimer tuile" Click="DeleteTile_Click" Tag="{Binding}"/>
                                    <Separator/>
                                    <MenuItem Header="Ajouter voie" Click="AddLineTrack_Click" Tag="{Binding}"/>
                                </MenuItem>
                            </Menu>
                        </Grid>
                        <ScrollViewer VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding LineTracks}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border BorderBrush="{DynamicResource TrackBorderBrush}" BorderThickness="1" CornerRadius="4" Padding="6" Margin="0,6,0,6">
                                            <StackPanel>
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="*"/>
                                                        <ColumnDefinition Width="Auto"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Grid.Column="0" Text="{Binding Name}" FontWeight="SemiBold"/>
                                                    <Menu Grid.Column="1" HorizontalAlignment="Right">
                                                        <MenuItem Header="...">
                                                            <MenuItem Header="Renommer voie" Click="RenameLineTrack_Click" Tag="{Binding}"/>
                                                            <MenuItem Header="Supprimer voie" Click="RemoveLineTrack_Click" Tag="{Binding}"/>
                                                        </MenuItem>
                                                    </Menu>
                                                </Grid>
                                                <TextBlock Text="{Binding LineInfo}" FontSize="11" Foreground="SlateGray" Margin="0,2,0,4"/>
                                                <Grid>
                                                    <ListBox x:Name="LineTrackList"
                                                             ItemsSource="{Binding Locomotives}"
                                                             Style="{StaticResource DropListBoxStyle}"
                                                             AllowDrop="True"
                                                             PreviewMouseLeftButtonDown="TrackLocomotives_PreviewMouseLeftButtonDown"
                                                             PreviewMouseMove="TrackLocomotives_PreviewMouseMove"
                                                             Drop="TrackLocomotives_Drop">
                                                        <ListBox.ItemsPanel>
                                                            <ItemsPanelTemplate>
                                                                <Canvas />
                                                            </ItemsPanelTemplate>
                                                        </ListBox.ItemsPanel>
                                                        <ListBox.ItemContainerStyle>
                                                            <Style TargetType="ListBoxItem">
                                                                <Setter Property="Canvas.Left" Value="{Binding AssignedTrackOffsetX, TargetNullValue=0}"/>
                                                                <Setter Property="Canvas.Top" Value="0"/>
                                                            </Style>
                                                        </ListBox.ItemContainerStyle>
                                                        <ListBox.ItemTemplate>
                                                            <DataTemplate>
                                                                <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                                                        Padding="4" Margin="2" CornerRadius="4"
                                                                        ContextMenu="{StaticResource LocomotiveTileContextMenu}">
                                                                    <Grid>
                                                                        <Grid.RowDefinitions>
                                                                            <RowDefinition Height="Auto"/>
                                                                            <RowDefinition Height="Auto"/>
                                                                        </Grid.RowDefinitions>
                                                                        <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                                                   HorizontalAlignment="Left"/>
                                                                        <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                                                   HorizontalAlignment="Right" Margin="0,2,0,0">
                                                                            <TextBlock.Style>
                                                                                <Style TargetType="TextBlock">
                                                                                    <Setter Property="Visibility" Value="Visible"/>
                                                                                    <Style.Triggers>
                                                                                        <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                                                        </DataTrigger>
                                                                                    </Style.Triggers>
                                                                                </Style>
                                                                            </TextBlock.Style>
                                                                        </TextBlock>
                                                                    </Grid>
                                                                </Border>
                                                            </DataTemplate>
                                                        </ListBox.ItemTemplate>
                                                    </ListBox>
                                                    <TextBlock Text="Déposez ici" Foreground="SlateGray" FontStyle="Italic"
                                                               HorizontalAlignment="Center" VerticalAlignment="Center">
                                                        <TextBlock.Style>
                                                            <Style TargetType="TextBlock">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding ElementName=LineTrackList, Path=HasItems}" Value="False">
                                                                        <Setter Property="Visibility" Value="Visible"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </TextBlock.Style>
                                                    </TextBlock>
                                                </Grid>
                                            </StackPanel>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </StackPanel>
                    <Thumb Width="14" Height="14" HorizontalAlignment="Right" VerticalAlignment="Bottom"
                           Cursor="SizeNWSE" DragDelta="TileResizeThumb_DragDelta" DragCompleted="TileResizeThumb_DragCompleted"
                           Background="#55000000" BorderBrush="#FF7A7A7A" BorderThickness="1"/>
                </Grid>
            </Border>
        </DataTemplate>
        <helpers:TileTemplateSelector x:Key="TileTemplateSelector"
                                    DepotTemplate="{StaticResource DepotTileTemplate}"
                                    GarageTemplate="{StaticResource GarageTileTemplate}"
                                    LineTemplate="{StaticResource LineTileTemplate}"/>
    </Window.Resources>
    <DockPanel>
        <Menu DockPanel.Dock="Top">
            <MenuItem Header="Fichier">
                <MenuItem Header="Sauvegarder" Click="MenuItem_Save_Click"/>
                <MenuItem Header="Charger" Click="MenuItem_Load_Click"/>
            </MenuItem>
            <MenuItem Header="Gestion">
                <MenuItem Header="Gestion des parcs" Click="MenuItem_PoolManagement_Click"/>
                <MenuItem Header="Historique" Click="MenuItem_History_Click"/>
            </MenuItem>
            <MenuItem Header="Tapis">
                <MenuItem Header="T13" Click="MenuItem_TapisT13_Click"/>
                <MenuItem Header="37000" IsEnabled="False"/>
            </MenuItem>
            <MenuItem Header="Vue">
                <MenuItem Header="Charger un preset" x:Name="ViewPresetsMenu"/>
                <MenuItem Header="Enregistrer le preset..." Click="SaveLayoutPreset_Click"/>
                <MenuItem Header="Supprimer un preset" x:Name="ViewPresetsDeleteMenu"/>
            </MenuItem>
            <MenuItem Header="Option">
                <MenuItem Header="Mode sombre" IsCheckable="True" Click="ToggleDarkMode_Click"/>
                <MenuItem Header="Réinitialiser">
                    <MenuItem Header="Réinitialiser locomotives" Click="MenuItem_ResetLocomotives_Click"/>
                    <MenuItem Header="Réinitialiser tuiles" Click="MenuItem_ResetTiles_Click"/>
                </MenuItem>
            </MenuItem>
        </Menu>
        <ToolBar DockPanel.Dock="Top">
            <Button Content="Ajouter un lieu" Click="AddPlace_Click"/>
        </ToolBar>
        <Grid>
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="260"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            <Border Grid.Column="0" Margin="10" Background="{DynamicResource PanelBackgroundBrush}" CornerRadius="6">
                <DockPanel>
                    <TextBlock DockPanel.Dock="Top" Text="Locomotives" FontWeight="Bold" Margin="8"/>
                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                        <ListBox x:Name="LocomotiveList"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                 ScrollViewer.VerticalScrollBarVisibility="Disabled"
                                 ScrollViewer.CanContentScroll="False"
                                 AllowDrop="True"
                                 Drop="LocomotiveList_Drop"
                                 PreviewMouseLeftButtonDown="LocomotiveList_PreviewMouseLeftButtonDown"
                                 PreviewMouseMove="LocomotiveList_PreviewMouseMove">
                        <ListBox.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel />
                            </ItemsPanelTemplate>
                        </ListBox.ItemsPanel>
                        <ListBox.ItemContainerStyle>
                            <Style TargetType="ListBoxItem">
                                <Setter Property="Visibility"
                                        Value="{Binding IsVisibleInActivePool, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                            </Style>
                        </ListBox.ItemContainerStyle>
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Border Background="{Binding Status, Converter={StaticResource StatutToBrushConverter}}"
                                        Padding="6" Margin="4" CornerRadius="4"
                                        ContextMenu="{StaticResource LocomotiveListContextMenu}">
                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <TextBlock Grid.Row="0" Text="{Binding Number}" Foreground="White" FontWeight="Bold" FontSize="12"
                                                   HorizontalAlignment="Left"/>
                                        <TextBlock Grid.Row="1" Text="{Binding TractionDisplay}" FontSize="10" Foreground="White"
                                                   HorizontalAlignment="Right" Margin="0,2,0,0">
                                            <TextBlock.Style>
                                                <Style TargetType="TextBlock">
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                    <Style.Triggers>
                                                        <DataTrigger Binding="{Binding TractionDisplay}" Value="">
                                                            <Setter Property="Visibility" Value="Collapsed"/>
                                                        </DataTrigger>
                                                    </Style.Triggers>
                                                </Style>
                                            </TextBlock.Style>
                                        </TextBlock>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                        </ListBox>
                    </ScrollViewer>
                </DockPanel>
            </Border>
            <Border Grid.Column="1" Margin="10" Background="{DynamicResource CanvasBackgroundBrush}" CornerRadius="6">
                <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
                    <ItemsControl x:Name="TileCanvas">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <Canvas />
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemContainerStyle>
                            <Style TargetType="ContentPresenter">
                                <Setter Property="Canvas.Left" Value="{Binding X}" />
                                <Setter Property="Canvas.Top" Value="{Binding Y}" />
                            </Style>
                        </ItemsControl.ItemContainerStyle>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <ContentControl Content="{Binding}" ContentTemplateSelector="{StaticResource TileTemplateSelector}"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Border>
        </Grid>
    </DockPanel>
</Window>
